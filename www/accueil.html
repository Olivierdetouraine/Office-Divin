<ons-page id='accueil'>
    <style>
        .barre-menu { 
            background-color: #930707 !important;
        }
        
        .page__content { 
            padding-top: 44px !important; 
            margin-top: 0 !important; 
        }

        /* STYLE DE BASE : Marron avec transparence 0.1 */
        .audio-office-full-button, .small-btn {
            background: rgba(139, 69, 19, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            color: white !important;
            border-radius: 12px !important;
            cursor: pointer;
        }

        /* OFFICES : 85PX + TEXTE À GAUCHE */
        .audio-office-full-button {
            margin: 14px 0 !important;
            min-height: 85px !important;
            height: 85px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: flex-start !important;
            padding: 0 25px !important;
        }

        .office-label {
            color: white !important;
            font-weight: bold !important;
            font-size: 19px !important; /* Un peu plus grand pour l'équilibre */
            flex-grow: 1;
            text-align: left !important;
        }

        /* COMMUNS : 65PX + TEXTE CENTRÉ */
        .small-btn { 
            min-height: 65px !important; 
            height: 65px !important; 
            margin: 10px 0 !important;
            width: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .center-text { 
            color: white !important;
            font-weight: bold !important;
            font-size: 16px !important;
            text-align: center !important;
            width: 100%;
        }

        .play-icon {
            color: white; 
            font-size: 30px;
        }

        #selection-title {
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            text-transform: uppercase;
        }

        #saint-title {
            color: white;
            text-align: center;
            font-family: 'Brush Script MT', 'Lucida Handwriting', cursive;
            font-size: 21px;
            padding: 8px 0;
            font-style: italic;
            background: transparent;
            margin-top: 40px;
        }
        
        #saint-type {
            color: #ffcccc;
            text-align: center;
            font-size: 14px;
            font-style: italic;
            margin-top: -5px;
        }
    </style>

    <ons-toolbar class="barre-menu">
        <div class="custom-header center" id="header-title" style="color: white;"></div>
    </ons-toolbar>

    <div style="max-width: 500px; margin: 0 auto; padding: 0 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; height: 40px;">
            <div id="btn-retour-home" onclick="resetToHome()" style="display: none; cursor: pointer;">
                <ons-icon icon="md-arrow-left" style="color: white; font-size: 28px;"></ons-icon>
            </div>
            <div id="communs-menu-trigger" onclick="toggleCommunsMenu()" style="display: flex; align-items: center; cursor: pointer; margin-left: auto;">
                <ons-icon icon="md-caret-down" style="color: white; font-size: 16px; margin-right: 8px;"></ons-icon>
                <span style="color: white; font-size: 13px; font-weight: bold;">Communs</span>
            </div>
        </div>
        
        <div id="saint-title"></div>
        <div id="saint-type"></div>

        <ons-list style="background: transparent; border: none;">
            <div id="offices-container">
                <div id="selection-title" style="display: none;"></div>
                
                <ons-list-item class="audio-office-full-button" onclick="actionOffice('laudes')" tappable>
                    <span class="office-label">Laudes</span> <ons-icon icon="md-play" class="play-icon"></ons-icon>
                </ons-list-item>

                <ons-list-item class="audio-office-full-button" onclick="actionOffice('milieu')" tappable>
                    <span class="office-label">Milieu du jour</span> <ons-icon icon="md-play" class="play-icon"></ons-icon>
                </ons-list-item>

                <ons-list-item class="audio-office-full-button" onclick="actionOffice('vepres')" tappable>
                    <span class="office-label">Vêpres</span> <ons-icon icon="md-play" class="play-icon"></ons-icon>
                </ons-list-item>

                <ons-list-item class="audio-office-full-button" onclick="actionOffice('complies')" tappable>
                    <span class="office-label">Complies</span> <ons-icon icon="md-play" class="play-icon"></ons-icon>
                </ons-list-item>

                <ons-list-item class="audio-office-full-button" onclick="actionOffice('lectures')" tappable>
                    <span class="office-label">Lectures</span> <ons-icon icon="md-play" class="play-icon"></ons-icon>
                </ons-list-item>
            </div>

            <div id="communs-categories-menu" style="display: none;">
                <div class="small-btn" onclick="showCommunsSubMenu('Marie', 'marie')"><span class="center-text">Marie</span></div>
                <div class="small-btn" onclick="showCommunsSubMenu('Apôtre', 'apotre')"><span class="center-text">Apôtre</span></div>
                <div class="small-btn" onclick="showCommunsSubMenu('Martyr', 'martyr')"><span class="center-text">Martyr</span></div>
                <div class="small-btn" onclick="showCommunsSubMenu('Docteur', 'docteur')"><span class="center-text">Docteur</span></div>
                <div class="small-btn" onclick="showCommunsSubMenu('Saint', 'saint')"><span class="center-text">Saint</span></div>
                <div class="small-btn" onclick="showCommunsSubMenu('Défunt', 'defunt')"><span class="center-text">Défunt</span></div>
                <div class="small-btn" onclick="showCommunsSubMenu('Dédicace', 'dedicace')"><span class="center-text">Dédicace</span></div>
            </div>
        </ons-list>
    </div>

    <script>
        var currentMode = "propre";
        var currentSaintID = "";

        document.addEventListener('init', function(event) {
            if (event.target.id === 'accueil') { 
                updateHeaderTitle();
                loadSaintTitle();
            }
        });

        function updateHeaderTitle() {
            if (typeof Date_du_jour === "function") {
                document.getElementById('header-title').innerHTML = "Office Divin du " + Date_du_jour(new Date());
            }
        }

        function loadSaintTitle() {
            // Récupérer la date actuelle ou celle stockée
            var dateStr = sessionStorage.getItem('date_c');
            if (!dateStr) {
                var d = new Date();
                dateStr = d.getFullYear() + "/" + 
                         ("0" + (d.getMonth() + 1)).slice(-2) + "/" + 
                         ("0" + d.getDate()).slice(-2);
            }
            
            // Extraire le mois et le jour
            var parts = dateStr.split('/');
            var mois = parts[1];
            var jour = parts[2];
            
            // Construire le chemin vers le fichier titre
            var titrePath = 'sanctoral/' + mois + '/' + jour + '-titre.html';
            
            // Charger le fichier titre
            fetch(titrePath)
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    return null;
                })
                .then(html => {
                    if (html) {
                        // Extraire le texte du titre et le type
                        var tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Récupérer le nom du saint
                        var titleText = tempDiv.querySelector('h3 b');
                        if (titleText) {
                            document.getElementById('saint-title').textContent = titleText.textContent;
                        }
                        
                        // Récupérer le type (Mémoire, Solennité, etc.)
                        var typeText = tempDiv.querySelector('p span.rouge i');
                        if (typeText) {
                            document.getElementById('saint-type').textContent = typeText.textContent;
                        }
                    }
                })
                .catch(err => {
                    console.log('Pas de titre sanctoral pour ce jour');
                });
        }

        function hideAudioPlayer() {
            let player = document.getElementById('mini-player');
            if (player) { player.style.display = 'none'; }
            if (window.currentAudio) { currentAudio.pause(); } 
        }

        function toggleCommunsMenu() {
            hideAudioPlayer();
            document.getElementById('communs-categories-menu').style.display = 'block';
            document.getElementById('offices-container').style.display = 'none';
            document.getElementById('btn-retour-home').style.display = 'block';
            document.getElementById('communs-menu-trigger').style.display = 'none';
        }

        function showCommunsSubMenu(label, id) {
            hideAudioPlayer();
            currentMode = "commun"; 
            currentSaintID = id;
            document.getElementById('communs-categories-menu').style.display = 'none';
            document.getElementById('offices-container').style.display = 'block';
            document.getElementById('selection-title').style.display = 'block';
            document.getElementById('selection-title').textContent = label;
        }

        function resetToHome() {
            hideAudioPlayer();
            currentMode = "propre";
            document.getElementById('communs-categories-menu').style.display = 'none';
            document.getElementById('offices-container').style.display = 'block';
            document.getElementById('selection-title').style.display = 'none';
            document.getElementById('btn-retour-home').style.display = 'none';
            document.getElementById('communs-menu-trigger').style.display = 'flex';
        }

   function actionOffice(office) {
    // 1. On vérifie si la date est enregistrée. Si non, on met celle du jour.
    if (!sessionStorage.getItem('date_c')) {
        var d = new Date();
        var date_formatee = d.getFullYear() + "/" + 
                           ("0" + (d.getMonth() + 1)).slice(-2) + "/" + 
                           ("0" + d.getDate()).slice(-2);
        sessionStorage.setItem('date_c', date_formatee);
    }

    // 2. On exécute la logique de Philoux pour trouver les psaumes du jour
    if (typeof Remplir_office === "function") {
        try {
            Remplir_office(office);
        } catch (e) {
            console.log("Note: Remplir_office a fini son calcul.");
        }
    }

    // 3. On lance ton lecteur audio
    setTimeout(function() {
        if (typeof preparerPlaylistDynamique === "function") {
            preparerPlaylistDynamique(office);
        }
    }, 500);
}
    </script>
</ons-page>